
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Geriatric Digoxin PK Digital Twin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    }

    body {
      background: #0f172a;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 24px;
    }

    .container {
      max-width: 1200px;
      width: 100%;
      background: #020617;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 0;
      overflow: hidden;
      border: 1px solid #1f2937;
    }

    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }
    }

    .sidebar {
      background: radial-gradient(circle at top left, #1f2937, #020617);
      padding: 24px 24px 32px;
      border-right: 1px solid #1f2937;
    }

    .main {
      padding: 24px 28px 28px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .title {
      font-size: 1.4rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 16px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.15);
      color: #7dd3fc;
      margin-bottom: 10px;
    }

    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin: 18px 0 8px;
      color: #e5e7eb;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 12px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
    }

    label {
      color: #9ca3af;
    }

    input,
    select {
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid #374151;
      background: rgba(15, 23, 42, 0.85);
      color: #e5e7eb;
      font-size: 0.85rem;
      outline: none;
    }

    input:focus,
    select:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
    }

    .button {
      width: 100%;
      margin-top: 18px;
      padding: 9px 12px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
    }

    .button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(22, 163, 74, 0.45);
    }

    .button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .main-top {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .stats-grid {
      margin-top: 4px;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 900px) {
      .stats-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .stat-card {
      background: #020617;
      border-radius: 14px;
      border: 1px solid #1f2937;
      padding: 8px 10px;
    }

    .stat-label {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-bottom: 3px;
    }

    .stat-value {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .stat-tag {
      font-size: 0.7rem;
      margin-top: 1px;
      color: #6b7280;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      padding: 6px 10px;
      border-radius: 999px;
      margin-top: 4px;
    }

    .status-pill span {
      font-weight: 500;
    }

    .status-under {
      background: rgba(59, 130, 246, 0.16);
      color: #bfdbfe;
    }

    .status-within {
      background: rgba(34, 197, 94, 0.16);
      color: #bbf7d0;
    }

    .status-over {
      background: rgba(239, 68, 68, 0.16);
      color: #fecaca;
    }

    .chart-card {
      margin-top: 12px;
      background: radial-gradient(circle at top right, #111827, #020617);
      border-radius: 16px;
      border: 1px solid #1f2937;
      padding: 12px 14px 16px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .chart-title {
      font-size: 0.9rem;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .chart-subtitle {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .chart-wrapper {
      margin-top: 8px;
      position: relative;
      height: 320px;
      width: 100%;
    }

    footer {
      font-size: 0.65rem;
      color: #6b7280;
      margin-top: 10px;
    }

    footer a {
      color: #93c5fd;
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }

    .explain-card {
      margin-top: 10px;
      background: #020617;
      border-radius: 14px;
      border: 1px solid #1f2937;
      padding: 10px 12px;
    }

    .explain-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
      color: #e5e7eb;
    }

    .explain-body {
      font-size: 0.8rem;
      line-height: 1.4;
      color: #9ca3af;
    }

    .preset-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }

    .preset-btn {
      flex: 1;
      padding: 4px 6px;
      font-size: 0.7rem;
      border-radius: 999px;
      border: 1px solid #374151;
      background: rgba(15, 23, 42, 0.9);
      color: #9ca3af;
      cursor: pointer;
    }

    .preset-btn:hover {
      border-color: #38bdf8;
      color: #e5e7eb;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Left: input panel -->
    <aside class="sidebar">
      <div class="badge">
        <span>üíä PK Digital Twin</span>
        <span style="opacity:0.7;">Digoxin ¬∑ Geriatric</span>
      </div>
      <h1 class="title">Geriatric Digoxin PK Simulator (v1.0)</h1>
      <p class="subtitle">
        Use age, weight, and renal function (CrCl as an eGFR surrogate)<br />
        to compute repeated IV bolus digoxin concentration‚Äìtime profiles,<br />
        and compare <b>the current patient vs a normal adult reference</b>.
      </p>

      <h2 class="section-title">1. Patient characteristics</h2>
      <div class="form-grid">
        <div class="form-group">
          <label for="age">Age (years)</label>
          <input id="age" type="number" min="18" max="100" value="80" />
        </div>
        <div class="form-group">
          <label for="weight">Weight (kg)</label>
          <input id="weight" type="number" min="30" max="150" step="0.5" value="55" />
        </div>
        <div class="form-group">
          <label for="sex">Sex</label>
          <select id="sex">
            <option value="M">Male</option>
            <option value="F" selected>Female</option>
          </select>
        </div>
        <div class="form-group">
          <label for="scr">Serum creatinine (mg/dL)</label>
          <input id="scr" type="number" min="0.3" max="5" step="0.1" value="1.3" />
        </div>
      </div>

      <div class="preset-row">
        <button class="preset-btn" id="adultPreset">
          Adult reference
        </button>
        <button class="preset-btn" id="geriatricPreset">
          Geriatric patient
        </button>
      </div>

      <h2 class="section-title">2. Dosing (Digoxin, IV bolus)</h2>
      <div class="form-grid">
        <div class="form-group">
          <label for="dose">Single dose (¬µg)</label>
          <input id="dose" type="number" min="62.5" max="500" step="12.5" value="125" />
        </div>
        <div class="form-group">
          <label for="tau">Dosing interval œÑ (h)</label>
          <input id="tau" type="number" min="12" max="72" step="1" value="24" />
        </div>
        <div class="form-group">
          <label for="nDoses">Number of doses</label>
          <input id="nDoses" type="number" min="1" max="30" step="1" value="20" />
        </div>
      </div>

      <button class="button" id="runBtn">
        ‚ñ∂ Run simulation
      </button>
    </aside>

    <!-- Right: results + chart -->
    <main class="main">
      <div class="main-top">
        <div>
          <div class="chart-title">Simulation summary (current patient)</div>
          <div class="chart-subtitle">
            Single-compartment educational digoxin PK model ¬∑ <b>current patient vs normal adult reference</b>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Current patient CrCl</div>
            <div class="stat-value" id="crclDisplay">‚Äì</div>
            <div class="stat-tag">mL/min (Cockcroft‚ÄìGault)</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Cmax,ss (current patient)</div>
            <div class="stat-value" id="cmaxDisplay">‚Äì</div>
            <div class="stat-tag">ng/mL</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Cmin,ss (current patient)</div>
            <div class="stat-value" id="cminDisplay">‚Äì</div>
            <div class="stat-tag">Last dosing interval (ng/mL)</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Exposure status (current patient)</div>
            <div id="statusPill" class="status-pill status-within" style="visibility:hidden;">
              <span id="statusText">‚Äì</span>
            </div>
          </div>
        </div>

        <!-- Explainable digital twin interpretation -->
        <div class="explain-card">
          <div class="explain-title">Clinical interpretation</div>
          <p id="explainText" class="explain-body">
            Enter patient characteristics on the left and click ‚ÄúRun simulation‚Äù to see the digoxin
            concentration pattern, toxicity risk, and how the current patient compares to a
            <b>normal adult reference</b> on the same dosing regimen.
          </p>
        </div>
      </div>

      <section class="chart-card">
        <div class="chart-title">Concentration‚Äìtime profile (repeated digoxin dosing)</div>
        <div class="chart-subtitle">
          Red dashed lines show an illustrative digoxin therapeutic range (0.5‚Äì1.0 ng/mL).<br />
          Solid line: current patient ¬∑ dashed line: normal adult reference on the same regimen.
        </div>

        <div class="chart-wrapper">
          <canvas id="pkChart"></canvas>
        </div>
      </section>

      <footer>
        ‚ö† This page is an educational / portfolio demo of a simplified digoxin PK simulator and
        must not be used to guide real clinical decision-making.
      </footer>
    </main>
  </div>

  <script>
  // -------------------------------
  // Digoxin educational PK model constants
  // -------------------------------
  const TV_CL = 7.0;     // L/h (typical clearance in adults, educational)
  const TV_V  = 500.0;   // L   (approx. 7 L/kg * 70 kg)

  // Illustrative digoxin therapeutic range (ng/mL)
  const THER_LOW  = 0.5;
  const THER_HIGH = 1.0;

  // Reference adult patient (for comparison)
  const REF_AGE   = 40;
  const REF_WT    = 70;
  const REF_SEX   = "M";
  const REF_SCR   = 0.9;

  // Cockcroft‚ÄìGault formula (CrCl, mL/min)
  function creatinineClearance(age, weight, scr, sex) {
    const factor = (sex === "F") ? 0.85 : 1.0;
    const crcl = ((140 - age) * weight * factor) / (72 * scr); // mL/min
    return crcl;
  }

  // Compute individualized CL, V, k given basic covariates
  function individualPkParams(age, weight, sex, scr) {
    const crcl = creatinineClearance(age, weight, scr, sex);

    // Educational scaling relative to CrCl 80 mL/min and weight 70 kg
    const CL = TV_CL * Math.pow(crcl / 80, 0.75);   // L/h
    const V  = TV_V  * (weight / 70.0);             // L
    const k  = CL / V;                              // 1/h

    return { CL, V, k, crcl };
  }

  // Multiple IV bolus simulation (one-compartment, first-order elimination)
  function simulateMultipleDoses(dose, tau, nDoses, CL, V, dt = 0.1) {
    const k = CL / V;
    const totalTime = tau * nDoses;
    const t = [];
    const C = [];

    // Initialize time grid and concentration
    for (let time = 0; time <= totalTime + 1e-9; time += dt) {
      t.push(time);
      C.push(0);
    }

    // Add contribution from each IV bolus dose
    for (let n = 0; n < nDoses; n++) {
      const tDose = n * tau;
      for (let i = 0; i < t.length; i++) {
        if (t[i] >= tDose) {
          const delta = t[i] - tDose;
          C[i] += (dose / V) * Math.exp(-k * delta); // ¬µg/L ‚âà ng/mL
        }
      }
    }
    return { t, C };
  }

  // Summarize exposure: global Cmax and Cmin over the last dosing interval
  function summarizeExposure(t, C, tau) {
    const cmax = Math.max(...C);

    const steadyStart = t[t.length - 1] - tau;
    let cmin = Infinity;
    for (let i = 0; i < t.length; i++) {
      if (t[i] >= steadyStart) {
        if (C[i] < cmin) cmin = C[i];
      }
    }
    if (!isFinite(cmin)) cmin = Math.min(...C);
    return { cmax, cmin };
  }

  function classifyExposure(cmin, low = THER_LOW, high = THER_HIGH) {
    if (cmin < low) return "underexposure";
    if (cmin > high) return "overexposure";
    return "within";
  }

  // Initialize Chart.js line chart
  let chartInstance = null;

  function initChart() {
    const ctx = document.getElementById("pkChart").getContext("2d");
    chartInstance = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "Current patient",
            data: [],
            borderWidth: 3,
            pointRadius: 0,
            tension: 0.2,
            borderColor: "#4ade80"   // bright green
          },
          {
            label: "Normal adult reference",
            data: [],
            borderWidth: 3,
            pointRadius: 0,
            tension: 0.2,
            borderDash: [6, 4],
            borderColor: "#38bdf8"   // bright blue
          },
          {
            label: "Therapeutic range lower bound (0.5 ng/mL)",
            data: [],
            borderWidth: 1.5,
            pointRadius: 0,
            tension: 0,
            borderDash: [4, 4],
            borderColor: "rgba(248,113,113,0.9)"
          },
          {
            label: "Therapeutic range upper bound (1.0 ng/mL)",
            data: [],
            borderWidth: 1.5,
            pointRadius: 0,
            tension: 0,
            borderDash: [4, 4],
            borderColor: "rgba(248,113,113,0.9)"
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: {
              display: true,
              text: "Time (h)",
              color: "#9ca3af"
            },
            ticks: {
              color: "#9ca3af",
              // Show clean integer ticks on the time axis
              callback: function (value) {
                return value.toFixed(0);
              }
            },
            grid: {
              color: "rgba(148, 163, 184, 0.2)"
            }
          },
          y: {
            min: 0,
            title: {
              display: true,
              text: "Concentration (ng/mL)",
              color: "#9ca3af"
            },
            ticks: {
              color: "#9ca3af"
            },
            grid: {
              color: "rgba(148, 163, 184, 0.2)"
            }
          }
        },
        plugins: {
          legend: {
            labels: {
              color: "#e5e7eb"
            }
          }
        }
      }
    });
  }

  function updateChart(t, Cpatient, Cadult) {
    if (!chartInstance) return;
    chartInstance.data.labels = t;
    chartInstance.data.datasets[0].data = Cpatient;             // current patient
    chartInstance.data.datasets[1].data = Cadult;               // normal adult
    chartInstance.data.datasets[2].data = t.map(() => THER_LOW);
    chartInstance.data.datasets[3].data = t.map(() => THER_HIGH);
    chartInstance.update();
  }

  // Main simulation pipeline
  function runSimulation() {
    const age = parseFloat(document.getElementById("age").value);
    const weight = parseFloat(document.getElementById("weight").value);
    const sex = document.getElementById("sex").value;
    const scr = parseFloat(document.getElementById("scr").value);
    const dose = parseFloat(document.getElementById("dose").value); // ¬µg
    const tau = parseFloat(document.getElementById("tau").value);
    const nDoses = parseInt(document.getElementById("nDoses").value, 10);

    if (
      !isFinite(age) || !isFinite(weight) || !isFinite(scr) ||
      !isFinite(dose) || !isFinite(tau) || !isFinite(nDoses) ||
      tau <= 0 || nDoses <= 0
    ) {
      alert("Please check your inputs.");
      return;
    }

    // Current patient
    const { CL, V, k, crcl } = individualPkParams(age, weight, sex, scr);
    const simPatient = simulateMultipleDoses(dose, tau, nDoses, CL, V);
    const { cmax, cmin } = summarizeExposure(simPatient.t, simPatient.C, tau);
    const status = classifyExposure(cmin);

    // Normal adult reference (same dose / œÑ / number of doses)
    const refParams = individualPkParams(REF_AGE, REF_WT, REF_SEX, REF_SCR);
    const simRef = simulateMultipleDoses(dose, tau, nDoses, refParams.CL, refParams.V);

    // Update numeric summaries (current patient)
    document.getElementById("crclDisplay").textContent = `${crcl.toFixed(1)}`;
    document.getElementById("cmaxDisplay").textContent = `${cmax.toFixed(2)}`;
    document.getElementById("cminDisplay").textContent = `${cmin.toFixed(2)}`;

    const pill = document.getElementById("statusPill");
    const text = document.getElementById("statusText");
    pill.classList.remove("status-under", "status-within", "status-over");
    pill.style.visibility = "visible";

    if (status === "underexposure") {
      pill.classList.add("status-under");
      text.textContent = "Underexposure (possible lack of efficacy)";
    } else if (status === "overexposure") {
      pill.classList.add("status-over");
      text.textContent = "Overexposure (increased digoxin toxicity risk)";
    } else {
      pill.classList.add("status-within");
      text.textContent = "Within range (nominal therapeutic window)";
    }

    // Update explainable interpretation text
    const explainText = document.getElementById("explainText");
    if (status === "underexposure") {
      explainText.textContent =
        `This patient's steady-state minimum digoxin concentration (Cmin,ss) is below the ` +
        `illustrative lower bound of the therapeutic range (${THER_LOW} ng/mL), indicating a risk ` +
        `of underexposure and insufficient efficacy. Compared with the normal adult reference on ` +
        `the same regimen, if the patient's curve lies consistently lower, it visually suggests ` +
        `subtherapeutic exposure. You could simulate scenarios such as increasing the dose or ` +
        `shortening the dosing interval (œÑ) to explore how exposure changes.`;
    } else if (status === "overexposure") {
      explainText.textContent =
        `This patient's steady-state minimum digoxin concentration (Cmin,ss) exceeds the ` +
        `illustrative upper bound of the therapeutic range (${THER_HIGH} ng/mL), indicating a ` +
        `high risk of digoxin toxicity. In particular, if the curve for this older, low-weight, ` +
        `renally impaired patient lies well above the normal adult reference on the same ` +
        `regimen, it suggests accumulation driven by reduced CrCl and a large volume of ` +
        `distribution. Clinical consequences may include arrhythmias, bradycardia, nausea/vomiting, ` +
        `and visual disturbances. Dose reduction (e.g., 125 ‚Üí 62.5 ¬µg) or extending the dosing ` +
        `interval (e.g., q24h ‚Üí q36‚Äì48h) should be considered in real-world practice‚Äîalthough this ` +
        `tool itself is not intended for clinical decision-making.`;
    } else {
      explainText.textContent =
        `This patient's steady-state minimum concentration (Cmin,ss) falls within the ` +
        `illustrative therapeutic range (${THER_LOW}‚Äì${THER_HIGH} ng/mL). If the current ` +
        `patient's curve is similar to, or slightly above, the normal adult reference curve, ` +
        `average toxicity risk does not appear extreme based on this simple model. However, in ` +
        `multi-morbid older adults, factors such as electrolyte imbalance or new interacting ` +
        `medications (e.g., P-gp inhibitors) can still shift exposure, so ongoing TDM and careful ` +
        `clinical monitoring remain important.`;
    }

    // Update chart
    updateChart(simRef.t, simPatient.C, simRef.C);
  }

  // Preset helpers
  function applyAdultPreset() {
    document.getElementById("age").value = REF_AGE;
    document.getElementById("weight").value = REF_WT;
    document.getElementById("sex").value = REF_SEX;
    document.getElementById("scr").value = REF_SCR;
    runSimulation();
  }

  function applyGeriatricPreset() {
    document.getElementById("age").value = 80;
    document.getElementById("weight").value = 55;
    document.getElementById("sex").value = "F";
    document.getElementById("scr").value = 1.3;
    runSimulation();
  }

  // Wire up events and run an initial simulation on page load
  window.addEventListener("DOMContentLoaded", () => {
    initChart();
    document.getElementById("runBtn").addEventListener("click", runSimulation);
    document.getElementById("adultPreset").addEventListener("click", applyAdultPreset);
    document.getElementById("geriatricPreset").addEventListener("click", applyGeriatricPreset);
    runSimulation(); // initial default view
  });
</script>
</body>
</html>
